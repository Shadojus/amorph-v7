---
/**
 * AMORPH v7 - Index Page
 * 
 * Hauptseite mit Grid-Ansicht und Morph-Showcase.
 */

import Base from '../layouts/Base.astro';
import { loadConfig, getAllPerspectives } from '../server/config';
import { searchItems, loadAllItems } from '../server/data';
import { renderValue, createSingleContext } from '../morphs';
import { detectType } from '../core/detection';
import type { RenderContext, MorphType } from '../core/types';

// Load config
await loadConfig();

// Morph-Priorisierung: Visuelle Morphs zuerst
// Partial Record - nicht alle MorphTypes mÃ¼ssen definiert sein
const MORPH_PRIORITY: Partial<Record<MorphType, number>> = {
  'bar': 1,
  'radar': 1,
  'sparkline': 2,
  'progress': 2,
  'range': 2,
  'stats': 2,
  'timeline': 3,
  'rating': 3,
  'badge': 4,
  'image': 4,
  'tag': 5,
  'list': 6,
  'object': 7,
  'text': 8,
  'number': 8,
  'boolean': 8,
  'date': 8,
  'link': 8
};

/**
 * Sortiert Felder nach Morph-Interesse (visuelle Morphs zuerst)
 */
function sortFieldsByInterest(entries: [string, unknown][]): [string, unknown][] {
  return entries.sort((a, b) => {
    const typeA = detectType(a[1], a[0]);
    const typeB = detectType(b[1], b[0]);
    const prioA = MORPH_PRIORITY[typeA] ?? 8;
    const prioB = MORPH_PRIORITY[typeB] ?? 8;
    return prioA - prioB;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MORPH SHOWCASE - Echte Felder aus den DatensÃ¤tzen gruppiert nach Morph-Typ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Alle Items laden um Showcase-Daten zu sammeln
const allItems = await loadAllItems();

/**
 * PrÃ¼ft ob ein Wert als gutes Showcase-Beispiel taugt
 */
function isGoodShowcaseValue(value: unknown, type: MorphType): boolean {
  if (value === null || value === undefined) return false;
  if (value === '') return false;
  if (typeof value === 'string' && value.length < 2) return false;
  
  // Progress/Range sollten nicht 0 sein
  if (type === 'progress') {
    if (typeof value === 'object' && value !== null) {
      const v = (value as any).value;
      if (v === 0 || v === undefined) return false;
      if (v < 10) return false; // Mindestens 10% fÃ¼r sichtbaren Progress
    }
  }
  
  // Rating sollte einen sichtbaren Wert haben
  if (type === 'rating') {
    if (typeof value === 'object' && value !== null) {
      const rating = (value as any).rating ?? (value as any).value;
      if (!rating || rating < 1) return false;
    }
    if (typeof value === 'number' && value < 1) return false;
  }
  
  // Badge sollte status haben
  if (type === 'badge') {
    if (typeof value === 'object' && value !== null) {
      const status = (value as any).status;
      if (!status || typeof status !== 'string') return false;
    }
  }
  
  // Arrays sollten Inhalt haben
  if (Array.isArray(value)) {
    if (value.length === 0) return false;
    // Bar/Radar brauchen mindestens 3 EintrÃ¤ge
    if ((type === 'bar' || type === 'radar') && value.length < 3) return false;
  }
  
  // Text sollte nicht zu kurz sein
  if (type === 'text') {
    if (typeof value === 'string' && value.length < 10) return false;
  }
  
  // Number sollte nicht 0 sein
  if (type === 'number') {
    if (typeof value === 'number' && value === 0) return false;
  }
  
  return true;
}

// Felder die nicht als Showcase verwendet werden sollen
const EXCLUDED_KEYS = new Set([
  'image', 'bild', 'foto', 'picture', 'thumbnail',
  'scientific', 'scientific_name', 'wissenschaftlich',
  'description', 'beschreibung', 'notes', 'notizen',
  'searchText', '_fieldPerspective'
]);

// Sammle ein Beispiel fÃ¼r jeden Morph-Typ aus echten Daten
const morphShowcase: Array<{type: MorphType, key: string, value: unknown, source: string}> = [];
const foundTypes = new Set<MorphType>();

// Durchsuche alle Items und ihre Felder
for (const item of allItems) {
  for (const [key, value] of Object.entries(item)) {
    // Skip interne und ausgeschlossene Felder
    if (key.startsWith('_') || ['id', 'slug', 'name'].includes(key)) continue;
    if (EXCLUDED_KEYS.has(key.toLowerCase())) continue;
    
    const morphType = detectType(value, key);
    
    // Nur ein Beispiel pro Morph-Typ, und nur gute Beispiele
    if (!foundTypes.has(morphType) && morphType !== 'null' && isGoodShowcaseValue(value, morphType)) {
      foundTypes.add(morphType);
      morphShowcase.push({
        type: morphType,
        key,
        value,
        source: item.name || item.slug || 'Unknown'
      });
    }
  }
}

// Sortiere nach Morph-PrioritÃ¤t (visuelle zuerst)
morphShowcase.sort((a, b) => {
  const prioA = MORPH_PRIORITY[a.type] ?? 8;
  const prioB = MORPH_PRIORITY[b.type] ?? 8;
  return prioA - prioB;
});

// Get search params
const url = new URL(Astro.request.url);
const query = url.searchParams.get('q') || '';
const perspectiveIds = url.searchParams.get('p')?.split(',').filter(Boolean) || [];

// Search
const { items, total, perspectivesWithData } = await searchItems({
  query,
  perspectives: perspectiveIds,
  limit: 50
});

// Get perspectives
const perspectives = getAllPerspectives();

// Perspektiven-Farben - Matte Pastell-TÃ¶ne (nicht leuchtend, klar von Bio-Farben unterscheidbar)
const perspectiveColors: Record<string, string[]> = {
  culinary: ['rgba(180, 140, 120, 0.6)'],
  safety: ['rgba(170, 130, 140, 0.6)'],
  cultivation: ['rgba(120, 150, 130, 0.6)'],
  medicine: ['rgba(150, 140, 170, 0.6)'],
  chemistry: ['rgba(160, 140, 160, 0.6)'],
  ecology: ['rgba(130, 150, 120, 0.6)'],
  statistics: ['rgba(165, 155, 140, 0.6)'],
  geography: ['rgba(160, 135, 120, 0.6)'],
  temporal: ['rgba(170, 160, 130, 0.6)'],
  economy: ['rgba(165, 150, 115, 0.6)'],
  conservation: ['rgba(115, 150, 145, 0.6)'],
  culture: ['rgba(155, 140, 160, 0.6)'],
  research: ['rgba(140, 145, 160, 0.6)'],
  interactions: ['rgba(175, 145, 135, 0.6)'],
  identification: ['rgba(145, 155, 125, 0.6)']
};

// Render context for grid items
const gridContext: RenderContext = {
  mode: 'grid',
  itemCount: 1,
  compact: true
};
---

<Base title="AMORPH â€“ Ãœbersicht">
  <!-- Perspektiven-Daten fÃ¼r Client -->
  <script define:vars={{ perspectiveColors, perspectives }}>
    window.AMORPH_PERSPECTIVE_COLORS = perspectiveColors;
    window.AMORPH_PERSPECTIVES = perspectives;
  </script>
  
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HEADER - Site-Switcher mit BifrÃ¶st Portal
       Funginomi (blau), Phytonomi (jade), Therionomi (tÃ¼rkis) â†’ BifrÃ¶st
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <header class="amorph-header">
    <!-- Nebel Container - wird ins BifrÃ¶st Portal gesaugt -->
    <div class="particle-field">
      <!-- Funginomi Nebel (blau) - linker Bereich -->
      <div class="particle particle-funginomi" style="--delay: 0s; --duration: 12s; --start-x: 0%; --width: 35%;"></div>
      <div class="particle particle-funginomi" style="--delay: 4s; --duration: 10s; --start-x: 5%; --width: 30%;"></div>
      <div class="particle particle-funginomi" style="--delay: 8s; --duration: 14s; --start-x: 2%; --width: 32%;"></div>
      <!-- Phytonomi Nebel (jade) - mittlerer Bereich -->
      <div class="particle particle-phytonomi" style="--delay: 1s; --duration: 11s; --start-x: 33%; --width: 34%;"></div>
      <div class="particle particle-phytonomi" style="--delay: 5s; --duration: 13s; --start-x: 30%; --width: 36%;"></div>
      <div class="particle particle-phytonomi" style="--delay: 9s; --duration: 10s; --start-x: 35%; --width: 32%;"></div>
      <!-- Therionomi Nebel (tÃ¼rkis) - rechter Bereich -->
      <div class="particle particle-therionomi" style="--delay: 2s; --duration: 10s; --start-x: 60%; --width: 30%;"></div>
      <div class="particle particle-therionomi" style="--delay: 6s; --duration: 12s; --start-x: 55%; --width: 35%;"></div>
      <div class="particle particle-therionomi" style="--delay: 10s; --duration: 11s; --start-x: 58%; --width: 32%;"></div>
    </div>
    
    <nav class="site-switcher">
      <a href="https://funginomi.com" class="site-link is-active" data-site="funginomi" title="Funginomi â€“ Pilze & Fungi">
        <span class="site-link-icon">ğŸ„</span>
        <span class="site-link-name">Funginomi</span>
      </a>
      <a href="https://phytonomi.com" class="site-link" data-site="phytonomi" title="Phytonomi â€“ Pflanzen & Flora">
        <span class="site-link-icon">ğŸŒ¿</span>
        <span class="site-link-name">Phytonomi</span>
      </a>
      <a href="https://therionomi.com" class="site-link" data-site="therionomi" title="Therionomi â€“ Tiere & Fauna">
        <span class="site-link-icon">ğŸ¦‹</span>
        <span class="site-link-name">Therionomi</span>
      </a>
      
      <!-- BifrÃ¶st Portal -->
      <a href="https://bifroest.io" class="bifroest-portal" title="BifrÃ¶st â€“ The Bridge">
        <span class="bifroest-label">part of the</span>
        <span class="bifroest-name">BifrÃ¶st</span>
        <span class="bifroest-vortex"></span>
      </a>
    </nav>
  </header>
  
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SEARCH BAR - Floating im Content
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="search-bar-container">
    <div class="search-bar-inner">
      <div class="search-input-wrapper">
        <span class="search-icon">ğŸ”</span>
        <input 
          type="search" 
          class="search-input-main"
          placeholder="Suchen..." 
          value={query}
          autocomplete="off"
        />
        <div class="search-nav" style="display: none;">
          <span class="search-nav-count">0/0</span>
          <button type="button" class="search-nav-prev" aria-label="Vorheriger Treffer">â†‘</button>
          <button type="button" class="search-nav-next" aria-label="NÃ¤chster Treffer">â†“</button>
        </div>
      </div>
    </div>
    <!-- Aktive Perspektiven unter Suche -->
    <div class="active-perspectives"></div>
  </div>
  
  <!-- Main Grid -->
  <main class="amorph-main">
    <!-- Morph Showcase - Immer sichtbar oben -->
    <details class="morph-showcase-details" open>
      <summary class="showcase-toggle">
        <span class="showcase-toggle-icon">ğŸ¨</span>
        <span>Morph Showcase</span>
        <span class="showcase-count">{morphShowcase.length} Typen</span>
      </summary>
      <div class="morph-showcase">
        <div class="showcase-header">
          <h2>AMORPH Visualisierungen</h2>
          <p class="showcase-subtitle">Automatisch erkannte Morph-Typen aus {allItems.length} DatensÃ¤tzen</p>
        </div>
        
        <div class="showcase-grid">
          {morphShowcase.map(({ type, key, value, source }) => (
            <div class="showcase-item" data-morph-type={type}>
              <div class="showcase-item-header">
                <span class="showcase-type">{type.toUpperCase()}</span>
                <span class="showcase-source">{source}</span>
              </div>
              <div class="showcase-item-key">{key}</div>
              <div class="showcase-item-content">
                <Fragment set:html={renderValue(value, key, gridContext)} />
              </div>
            </div>
          ))}
        </div>
      </div>
    </details>
    
    <div class="amorph-grid">
      {items.map(item => {
        // Encode field-perspective mapping for client-side use
        const fieldPerspectiveMap = item._fieldPerspective || {};
        const fieldPerspectiveJson = JSON.stringify(fieldPerspectiveMap);
        
        return (
          <article 
            class="amorph-item"
            data-slug={item.slug}
            data-id={item.id}
            data-name={item.name}
            data-field-perspectives={fieldPerspectiveJson}
          >
            <div class="item-header">
              {item.bild && (
                <div class="item-image">
                  <img src={String(item.bild)} alt={item.name} loading="lazy" />
                </div>
              )}
              <div class="item-title-row">
                <h2 class="item-name">{item.name}</h2>
                <a href={`/${item.slug}`} class="item-detail-link" title="Details anzeigen">â†’</a>
              </div>
              {item.wissenschaftlich && (
                <span class="item-scientific">{String(item.wissenschaftlich)}</span>
              )}
            </div>
            
            <div class="item-body">
              {sortFieldsByInterest(
                Object.entries(item)
                  .filter(([k]) => !['id', 'slug', 'name', 'bild', 'wissenschaftlich'].includes(k) && !k.startsWith('_'))
              )
                .slice(0, 6)
                .map(([key, value]) => (
                  <Fragment set:html={renderValue(value, key, gridContext)} />
                ))
              }
            </div>
          </article>
        );
      })}
    </div>
    
    {items.length === 0 && (
      <div class="empty-state">
        <span class="empty-icon">ğŸ”</span>
        <p>Keine Ergebnisse gefunden</p>
      </div>
    )}
  </main>
  
  <!-- Selection Bar -->
  <div class="selection-bar">
    <div class="selection-pills"></div>
    <span class="selection-count">0 ausgewÃ¤hlt</span>
    <button class="selection-clear">Alle entfernen</button>
  </div>
  
  <!-- Compare Panel (Overlay) -->
  <aside class="amorph-compare">
    <div class="compare-header">
      <h2>Vergleich</h2>
      <button class="compare-close">Ã—</button>
    </div>
    <div class="compare-content">
      <!-- Filled via JS -->
    </div>
  </aside>
  
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FOOTER - Minimal
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <footer class="amorph-footer">
    <div class="footer-content">
      <nav class="footer-links">
        <a href="/impressum" class="footer-link">Impressum</a>
        <a href="/datenschutz" class="footer-link">Datenschutz</a>
        <a href="/about" class="footer-link">Ãœber AMORPH</a>
        <a href="https://github.com" class="footer-link" target="_blank">GitHub</a>
      </nav>
      <p class="footer-copyright">Â© 2025 AMORPH Â· <a href="/">Formlos. Zustandslos. Transformierend.</a></p>
    </div>
  </footer>
  
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BOTTOM NAVIGATION - Fixed App Navigation
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <nav class="bottom-nav">
    <a href="/" class="bottom-nav-item is-active" data-nav="home">
      <span class="bottom-nav-icon">ğŸ </span>
      <span class="bottom-nav-label">Home</span>
    </a>
    <button type="button" class="bottom-nav-item" data-nav="compare">
      <span class="bottom-nav-icon">âš–ï¸</span>
      <span class="bottom-nav-label">Compare</span>
      <span class="bottom-nav-badge">0</span>
    </button>
    <a href="/bifroest" class="bottom-nav-item" data-nav="bifroest">
      <span class="bottom-nav-icon">ğŸŒˆ</span>
      <span class="bottom-nav-label">BifrÃ¶st</span>
    </a>
  </nav>
</Base>
