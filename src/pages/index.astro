---
/**
 * AMORPH v8.7 - Unified Landing Page
 * 
 * Route: /
 * Design: Kopiert von [domain].astro mit:
 * - Alle 17 Domains laden
 * - Bloom-Controls mit Score-basierter Filterung
 * - My Species & Bifroest Activator
 */

import Base from '../layouts/Base.astro';
import { loadConfig, getAllPerspectives, getSiteType, SITE_META, type SiteType } from '../server/config';
import { loadGlobalItems } from '../server/data';
import { renderValue, createSingleContext } from '../morphs';
import { detectType } from '../core/detection';
import type { RenderContext, MorphType } from '../core/types';

// Load config
await loadConfig();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPER-DOMAIN KONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const superDomains = {
  life: {
    name: 'LIFE',
    symbol: 'ğŸŒ±',
    color: '#6B9B8A',
    domains: ['fungi', 'phyto', 'drako', 'bakterio', 'viro']
  },
  science: {
    name: 'SCIENCE', 
    symbol: 'ğŸ”¬',
    color: '#7B82A8',
    domains: ['geno', 'anato', 'chemo', 'physi', 'kosmo']
  },
  earth: {
    name: 'EARTH',
    symbol: 'ğŸŒ', 
    color: '#8F7A5A',
    domains: ['mine', 'tekto', 'paleo']
  },
  systems: {
    name: 'SYSTEMS',
    symbol: 'ğŸ”—',
    color: '#5A7A8F',
    domains: ['netzo', 'cognito', 'biotech', 'socio']
  }
};

// Reverse mapping: domain -> superDomain
const domainToSuperDomain: Record<string, string> = {};
for (const [superDomain, config] of Object.entries(superDomains)) {
  for (const domain of config.domains) {
    domainToSuperDomain[domain] = superDomain;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENGAGEMENT-OPTIMIERTE FELD-PRIORISIERUNG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const HIGH_VALUE_FIELDS = [
  'description',
  'special_feature', 'special_ecological_feature', 'effect_profile',
  'historical_significance', 'keystone_species', 'keystone_function',
  'bioremediation_potential', 'bioluminescence',
  'venom_source', 'electric_discharge_max', 'regeneration_capability',
  'intelligence', 'bite_force', 'running_speed_max', 'strike_speed',
  'migration_distance', 'waggle_dance_communication', 'neoteny',
  'allelopathic_effects', 'invasiveness_score', 'carbon_storage_capacity',
  'safety_potentially_deadly', 'safety_warning_level', 'safety_warning_text',
  'safety_summary', 'safety_edibility_status', 'safety_risk_inherent',
  'encounter_protocol', 'toxicity_level', 'edibility_status', 'confusion_risk_level',
  'primary_medicinal_uses', 'traditional_medicine_systems', 'traditional_medicine_use',
  'tcm_therapeutic_actions', 'tcm_meridian_tropism', 'ayurveda_dosha_effect',
  'ayurveda_rasa', 'mechanism_of_action', 'active_compounds', 'bioactive_compounds',
  'clinical_evidence_level', 'medicinal_status',
  'culinary_rating', 'flavor_profile', 'signature_dishes_famous',
  'best_cooking_methods', 'cuisine_traditions', 'wine_pairing', 'aroma_profile', 'texture',
  'ecological_role', 'ecological_guild', 'trophic_mode_primary', 'ecological_importance',
  'ecosystem_services', 'primary_ecosystem_function', 'habitat_primary', 'habitat_types',
  'iucn_global_status', 'population_trend', 'conservation_status', 'native_range',
  'identification_difficulty', 'key_differentiating_features', 'common_names',
  'size_range', 'weight_range'
];

const MORPH_PRIORITY: Partial<Record<MorphType, number>> = {
  'badge': 1, 'severity': 1, 'bar': 2, 'radar': 2, 'sparkline': 3,
  'progress': 3, 'stats': 3, 'rating': 4, 'range': 5, 'timeline': 5,
  'list': 6, 'tag': 6, 'image': 7, 'object': 8, 'text': 9,
  'number': 9, 'boolean': 9, 'date': 9, 'link': 9
};

function sortFieldsByInterest(entries: [string, unknown][], itemName?: string): [string, unknown][] {
  const sorted = entries.sort((a, b) => {
    const keyA = a[0];
    const keyB = b[0];
    const hvIndexA = HIGH_VALUE_FIELDS.indexOf(keyA);
    const hvIndexB = HIGH_VALUE_FIELDS.indexOf(keyB);
    
    if (hvIndexA !== -1 && hvIndexB !== -1) return hvIndexA - hvIndexB;
    if (hvIndexA !== -1) return -1;
    if (hvIndexB !== -1) return 1;
    
    const typeA = detectType(a[1], keyA);
    const typeB = detectType(b[1], keyB);
    const prioA = MORPH_PRIORITY[typeA] ?? 10;
    const prioB = MORPH_PRIORITY[typeB] ?? 10;
    return prioA - prioB;
  });
  
  return sorted;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA LOADING - Alle Domains
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const allItems = await loadGlobalItems();
console.log(`[Landing] Loaded ${allItems.length} items from all domains`);

// Berechne Super-Domain Scores fÃ¼r jedes Item
const itemsWithScores = allItems.map(item => {
  const domainSlug = item._domainSlug || '';
  const superDomain = domainToSuperDomain[domainSlug] || 'systems';
  
  // Base Score aus Domain-ZugehÃ¶rigkeit (0-1)
  const scores: Record<string, number> = {
    life: 0,
    science: 0, 
    earth: 0,
    systems: 0
  };
  
  // PrimÃ¤re Domain = 1.0
  scores[superDomain] = 1.0;
  
  // Engagement Score als Multiplikator (0.5-1.5)
  const engagementMultiplier = 0.5 + ((item.engagementScore || 50) / 100);
  
  return {
    ...item,
    _superDomainScores: scores,
    _primarySuperDomain: superDomain,
    _engagementMultiplier: engagementMultiplier
  };
});

// Get perspectives
const perspectives = getAllPerspectives();

// Perspektiven-Farben
const perspectiveColors: Record<string, string[]> = {};
perspectives.forEach((p, i) => {
  const hue = (i * 37) % 360;
  perspectiveColors[p.id] = [`hsla(${hue}, 30%, 50%, 0.2)`];
});

// Render context
const gridContext: RenderContext = {
  mode: 'grid',
  itemCount: 1,
  compact: true
};

// Domain colors for pills
const domainColors: Record<string, { color: string; icon: string; name: string }> = {
  fungi: { color: '#8B9DC3', icon: 'ğŸ„', name: 'Fungi' },
  phyto: { color: '#7A9E7E', icon: 'ğŸŒ¿', name: 'Plantae' },
  drako: { color: '#7A9E9E', icon: 'ğŸ‰', name: 'Therion' },
  bakterio: { color: '#9E8B7A', icon: 'ğŸ¦ ', name: 'Bakterio' },
  viro: { color: '#7A8B9E', icon: 'ğŸ§¬', name: 'Viro' },
  geno: { color: '#8E7A9E', icon: 'ğŸ§¬', name: 'Geno' },
  anato: { color: '#9E7A8B', icon: 'ğŸ«€', name: 'Anato' },
  chemo: { color: '#7A9E8B', icon: 'âš—ï¸', name: 'Chemo' },
  physi: { color: '#8B7A9E', icon: 'âš›ï¸', name: 'Physi' },
  kosmo: { color: '#7A8E9E', icon: 'ğŸŒŒ', name: 'Kosmo' },
  mine: { color: '#9E8E7A', icon: 'ğŸ’', name: 'Mine' },
  tekto: { color: '#8E9E7A', icon: 'ğŸŒ‹', name: 'Tekto' },
  paleo: { color: '#9E7A7A', icon: 'ğŸ¦´', name: 'Paleo' },
  netzo: { color: '#7A7A9E', icon: 'ğŸŒ', name: 'Netzo' },
  cognito: { color: '#9E9E7A', icon: 'ğŸ§ ', name: 'Cognito' },
  biotech: { color: '#7A9E9E', icon: 'ğŸ”¬', name: 'Biotech' },
  socio: { color: '#9E7A9E', icon: 'ğŸ‘¥', name: 'Socio' }
};

// Serialize for client
const superDomainsJson = JSON.stringify(superDomains);
const domainToSuperDomainJson = JSON.stringify(domainToSuperDomain);
const itemScoresJson = JSON.stringify(itemsWithScores.map(item => ({
  slug: item.slug,
  scores: item._superDomainScores,
  primary: item._primarySuperDomain,
  engagement: item._engagementMultiplier
})));
---

<Base title="AMORPH â€“ Universelle Ãœbersicht">
  <!-- Client Data -->
  <script define:vars={{ perspectiveColors, perspectives, superDomainsJson, domainToSuperDomainJson, itemScoresJson }}>
    window.AMORPH_PERSPECTIVE_COLORS = perspectiveColors;
    window.AMORPH_PERSPECTIVES = perspectives;
    window.AMORPH_SUPER_DOMAINS = JSON.parse(superDomainsJson);
    window.AMORPH_DOMAIN_TO_SUPER = JSON.parse(domainToSuperDomainJson);
    window.AMORPH_ITEM_SCORES = JSON.parse(itemScoresJson);
  </script>
  
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       BLOOM CONTROLS - 4 Ecken fÃ¼r Super-Domain Gewichtung
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="bloom-controls">
    <div class="bloom-control top-left" data-superdomain="life" style={`--bloom-color: ${superDomains.life.color};`}>
      <div class="bloom-glow"></div>
      <div class="bloom-circle"></div>
      <span class="bloom-label">{superDomains.life.name}</span>
      <span class="bloom-value">50%</span>
      <input type="range" class="bloom-slider" min="0" max="100" value="50" />
    </div>
    <div class="bloom-control top-right" data-superdomain="science" style={`--bloom-color: ${superDomains.science.color};`}>
      <div class="bloom-glow"></div>
      <div class="bloom-circle"></div>
      <span class="bloom-label">{superDomains.science.name}</span>
      <span class="bloom-value">50%</span>
      <input type="range" class="bloom-slider" min="0" max="100" value="50" />
    </div>
    <div class="bloom-control bottom-left" data-superdomain="earth" style={`--bloom-color: ${superDomains.earth.color};`}>
      <div class="bloom-glow"></div>
      <div class="bloom-circle"></div>
      <span class="bloom-label">{superDomains.earth.name}</span>
      <span class="bloom-value">50%</span>
      <input type="range" class="bloom-slider" min="0" max="100" value="50" />
    </div>
    <div class="bloom-control bottom-right" data-superdomain="systems" style={`--bloom-color: ${superDomains.systems.color};`}>
      <div class="bloom-glow"></div>
      <div class="bloom-circle"></div>
      <span class="bloom-label">{superDomains.systems.name}</span>
      <span class="bloom-value">50%</span>
      <input type="range" class="bloom-slider" min="0" max="100" value="50" />
    </div>
  </div>
  
  <!-- Fog Corner Effects -->
  <div class="fog-corners">
    <div class="fog-corner fog-top-left" style={`--fog-color: ${superDomains.life.color};`}></div>
    <div class="fog-corner fog-top-right" style={`--fog-color: ${superDomains.science.color};`}></div>
    <div class="fog-corner fog-bottom-left" style={`--fog-color: ${superDomains.earth.color};`}></div>
    <div class="fog-corner fog-bottom-right" style={`--fog-color: ${superDomains.systems.color};`}></div>
  </div>
  
  <!-- Bloom Controls Script -->
  <script>
    // Bloom Controls - Score-basierte Filterung
    const bloomControls = document.querySelectorAll('.bloom-control');
    const grid = document.querySelector('.amorph-grid');
    const itemScores = window.AMORPH_ITEM_SCORES || [];
    
    // State
    const superDomainWeights = {
      life: 50, science: 50, earth: 50, systems: 50
    };
    
    // Build score lookup
    const scoreMap = new Map();
    itemScores.forEach((item) => {
      scoreMap.set(item.slug, { scores: item.scores, engagement: item.engagement });
    });
    
    // Update fog intensity based on weights
    function updateFogEffects() {
      const fogCorners = document.querySelectorAll('.fog-corner');
      const mapping = ['life', 'science', 'earth', 'systems'];
      fogCorners.forEach((fog, i) => {
        const superDomain = mapping[i];
        const weight = superDomainWeights[superDomain] || 50;
        const intensity = weight / 100;
        fog.style.opacity = String(intensity * 0.6);
      });
    }
    
    // Calculate item visibility score based on bloom weights
    function calculateItemScore(slug) {
      const data = scoreMap.get(slug);
      if (!data) return 0.5;
      
      let totalScore = 0;
      let totalWeight = 0;
      
      for (const [superDomain, weight] of Object.entries(superDomainWeights)) {
        const itemScore = data.scores[superDomain] || 0;
        totalScore += itemScore * (weight / 100);
        totalWeight += weight / 100;
      }
      
      // Normalize and apply engagement multiplier
      const normalizedScore = totalWeight > 0 ? totalScore / totalWeight : 0.5;
      return normalizedScore * data.engagement;
    }
    
    // Apply bloom filtering
    function applyBloomFilter() {
      if (!grid) return;
      
      const items = grid.querySelectorAll('.amorph-item');
      const scores = [];
      
      items.forEach(item => {
        const slug = item.dataset.slug || '';
        const score = calculateItemScore(slug);
        scores.push({ item, score });
        
        // Apply opacity based on score
        const opacity = 0.3 + (score * 0.7);
        item.style.opacity = String(Math.min(opacity, 1));
        item.style.setProperty('--item-score', String(score));
      });
      
      // Sort items by score (highest first)
      scores.sort((a, b) => b.score - a.score);
      scores.forEach(({ item }) => {
        grid.appendChild(item);
      });
      
      updateFogEffects();
    }
    
    // Initialize bloom controls
    bloomControls.forEach(control => {
      const slider = control.querySelector<HTMLInputElement>('.bloom-slider');
      const valueDisplay = control.querySelector<HTMLElement>('.bloom-value');
      const glow = control.querySelector<HTMLElement>('.bloom-glow');
      const superDomain = control.dataset.superdomain || '';
      
      if (slider) {
        slider.addEventListener('input', () => {
          const value = parseInt(slider.value, 10);
          superDomainWeights[superDomain] = value;
          
          if (valueDisplay) {
            valueDisplay.textContent = `${value}%`;
          }
          
          // Update glow intensity
          if (glow) {
            glow.style.opacity = String(value / 100);
          }
          
          applyBloomFilter();
        });
      }
    });
    
    // Initial filter
    setTimeout(applyBloomFilter, 100);
  </script>
  
  <!-- View Toggle Script -->
  <script>
    const viewToggleBtns = document.querySelectorAll('.view-toggle-btn');
    const mainGrid = document.querySelector('.amorph-grid');
    const savedView = localStorage.getItem('amorph-view') || 'grid';
    const compactFilters = document.querySelector('.compact-filters');
    const filterBtns = document.querySelectorAll('.filter-btn');
    
    function setView(view) {
      if (!mainGrid) return;
      mainGrid.classList.toggle('view-compact', view === 'compact');
      viewToggleBtns.forEach(btn => {
        btn.classList.toggle('is-active', btn.dataset.view === view);
      });
      const searchNav = document.querySelector('.search-nav');
      if (searchNav) searchNav.classList.toggle('compact-hidden', view === 'compact');
      if (compactFilters) compactFilters.style.display = view === 'compact' ? 'flex' : 'none';
      localStorage.setItem('amorph-view', view);
    }
    
    // Filter Logic
    let activePerspectiveFilters = [];
    const MAX_PERSPECTIVES = 4;
    let filterMode = 'or';
    let currentCluster = 'default';
    const perspColors = window.AMORPH_PERSPECTIVE_COLORS || {};
    
    function applyFilters() {
      if (!mainGrid) return;
      const items = mainGrid.querySelectorAll('.amorph-item');
      
      items.forEach(item => {
        const perspectiveCounts = JSON.parse(item.dataset.perspectiveCounts || '{}');
        if (activePerspectiveFilters.length === 0) {
          item.style.display = '';
          return;
        }
        
        let matchCount = 0;
        for (const persp of activePerspectiveFilters) {
          if ((perspectiveCounts[persp] || 0) > 0) matchCount++;
        }
        
        const passesFilter = filterMode === 'or' ? matchCount > 0 : matchCount === activePerspectiveFilters.length;
        item.style.display = passesFilter ? '' : 'none';
      });
    }
    
    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const filterType = btn.dataset.filter;
        const value = btn.dataset.value || '';
        
        if (filterType === 'perspective') {
          if (value === 'all') {
            activePerspectiveFilters = [];
          } else {
            const idx = activePerspectiveFilters.indexOf(value);
            if (idx !== -1) {
              activePerspectiveFilters.splice(idx, 1);
            } else {
              activePerspectiveFilters.push(value);
              if (activePerspectiveFilters.length > MAX_PERSPECTIVES) {
                activePerspectiveFilters.shift();
              }
            }
          }
          document.querySelectorAll('.filter-btn[data-filter="perspective"]').forEach(b => {
            const btnValue = b.getAttribute('data-value') || '';
            if (btnValue === 'all') {
              b.classList.toggle('is-active', activePerspectiveFilters.length === 0);
            } else {
              b.classList.toggle('is-active', activePerspectiveFilters.includes(btnValue));
            }
          });
        } else if (filterType === 'cluster') {
          currentCluster = value;
          document.querySelectorAll('.filter-btn[data-filter="cluster"]').forEach(b => {
            b.classList.toggle('is-active', b.getAttribute('data-value') === value);
          });
        } else if (filterType === 'mode') {
          filterMode = filterMode === 'or' ? 'and' : 'or';
          const modeBtn = document.querySelector('.filter-mode-btn') as HTMLElement;
          if (modeBtn) modeBtn.textContent = filterMode.toUpperCase();
        }
        applyFilters();
      });
    });
    
    setView(savedView);
    viewToggleBtns.forEach(btn => {
      btn.addEventListener('click', () => setView(btn.dataset.view || 'grid'));
    });
  </script>
  
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HEADER - Site-Switcher mit Bifroest Portal
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <header class="amorph-header">
    <div class="particle-field">
      <div class="particle particle-funginomi" style="--delay: 0s; --duration: 12s; --start-x: 0%; --width: 35%;"></div>
      <div class="particle particle-funginomi" style="--delay: 4s; --duration: 10s; --start-x: 5%; --width: 30%;"></div>
      <div class="particle particle-funginomi" style="--delay: 8s; --duration: 14s; --start-x: 2%; --width: 32%;"></div>
      <div class="particle particle-phytonomi" style="--delay: 1s; --duration: 11s; --start-x: 33%; --width: 34%;"></div>
      <div class="particle particle-phytonomi" style="--delay: 5s; --duration: 13s; --start-x: 30%; --width: 36%;"></div>
      <div class="particle particle-phytonomi" style="--delay: 9s; --duration: 10s; --start-x: 35%; --width: 32%;"></div>
      <div class="particle particle-drakonomi" style="--delay: 2s; --duration: 10s; --start-x: 60%; --width: 30%;"></div>
      <div class="particle particle-drakonomi" style="--delay: 6s; --duration: 12s; --start-x: 55%; --width: 35%;"></div>
      <div class="particle particle-drakonomi" style="--delay: 10s; --duration: 11s; --start-x: 58%; --width: 32%;"></div>
    </div>
    
    <nav class="site-switcher">
      <a href="/fungi" class="site-link" data-site="funginomi" title="Funginomi â€“ Pilze & Fungi">
        <svg class="site-link-icon" viewBox="0 0 24 24" fill="currentColor">
          <ellipse cx="12" cy="8" rx="7" ry="5"/>
          <rect x="10" y="12" width="4" height="8" rx="1"/>
        </svg>
        <span class="site-link-name">Funginomi</span>
      </a>
      <a href="/phyto" class="site-link" data-site="phytonomi" title="Phytonomi â€“ Pflanzen & Flora">
        <svg class="site-link-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M17 8C8 10 5.9 16.17 3.82 21.34l1.89.66.95-2.3c.48.17.98.3 1.34.3C19 20 22 3 22 3c-1 2-8 2.25-13 3.25S2 11.5 2 13.5s1.75 3.75 1.75 3.75C7 8 17 8 17 8z"/>
        </svg>
        <span class="site-link-name">Phytonomi</span>
      </a>
      <a href="/drako" class="site-link" data-site="drakonomi" title="Drakonomi â€“ Tiere & Fauna">
        <svg class="site-link-icon" viewBox="0 0 24 24" fill="currentColor">
          <ellipse cx="12" cy="17" rx="5" ry="4"/>
          <circle cx="7" cy="10" r="2.5"/>
          <circle cx="17" cy="10" r="2.5"/>
          <circle cx="5" cy="14" r="2"/>
          <circle cx="19" cy="14" r="2"/>
        </svg>
        <span class="site-link-name">Drakonomi</span>
      </a>
      
      <a href="https://bifroest.io" class="bifroest-portal" title="Bifroest â€“ The Bridge">
        <span class="bifroest-label">part of the</span>
        <span class="bifroest-name">Bifroest</span>
        <span class="bifroest-vortex"></span>
      </a>
    </nav>
  </header>
  
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SEARCH BAR
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="search-bar-container">
    <div class="search-bar-inner">
      <div class="search-input-wrapper">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
        <input 
          type="search" 
          class="search-input-main"
          placeholder="Search across all domains..." 
          autocomplete="off"
        />
        <div class="search-nav" style="display: none;">
          <span class="search-nav-count">0/0</span>
          <button type="button" class="search-nav-prev" aria-label="Vorheriger Treffer">â†‘</button>
          <button type="button" class="search-nav-next" aria-label="NÃ¤chster Treffer">â†“</button>
        </div>
        <div class="view-toggle">
          <button type="button" class="view-toggle-btn is-active" data-view="grid" title="Grid View">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <rect x="3" y="3" width="7" height="7" rx="1"/>
              <rect x="14" y="3" width="7" height="7" rx="1"/>
              <rect x="3" y="14" width="7" height="7" rx="1"/>
              <rect x="14" y="14" width="7" height="7" rx="1"/>
            </svg>
          </button>
          <button type="button" class="view-toggle-btn" data-view="compact" title="Compact Gallery">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <rect x="3" y="3" width="4" height="4" rx="0.5"/>
              <rect x="10" y="3" width="4" height="4" rx="0.5"/>
              <rect x="17" y="3" width="4" height="4" rx="0.5"/>
              <rect x="3" y="10" width="4" height="4" rx="0.5"/>
              <rect x="10" y="10" width="4" height="4" rx="0.5"/>
              <rect x="17" y="10" width="4" height="4" rx="0.5"/>
              <rect x="3" y="17" width="4" height="4" rx="0.5"/>
              <rect x="10" y="17" width="4" height="4" rx="0.5"/>
              <rect x="17" y="17" width="4" height="4" rx="0.5"/>
            </svg>
          </button>
        </div>
      </div>
      
      <!-- Compact Filters -->
      <div class="compact-filters" style="display: none;">
        <button type="button" class="filter-header-toggle" aria-expanded="true">
          <span class="filter-header-label">Filter</span>
          <span class="filter-header-count"></span>
          <svg class="filter-header-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </button>
        
        <div class="filter-content">
          <div class="filter-group filter-perspective">
            <span class="filter-label">Perspektive</span>
            <button type="button" class="filter-btn is-active" data-filter="perspective" data-value="all" title="Alle anzeigen">
              <span class="filter-icon">âœ¨</span>
              <span class="filter-text">Alle</span>
            </button>
            {perspectives.map((p, i) => (
              <button 
                type="button" 
                class="filter-btn" 
                data-filter="perspective" 
                data-value={p.id} 
                data-color={`hsla(${(i * 37) % 360}, 30%, 50%, 0.6)`}
                title={p.name}
              >
                <span class="filter-icon">{p.symbol}</span>
                <span class="filter-text">{p.name}</span>
              </button>
            ))}
          </div>
          
          <div class="filter-group filter-mode-toggle" style="display: none;">
            <span class="filter-label">Modus</span>
            <button type="button" class="filter-btn filter-mode-btn" data-filter="mode" title="OR = mindestens eine, AND = alle Perspektiven">
              OR
            </button>
          </div>
          
          <div class="filter-group filter-cluster">
            <span class="filter-label">Sortierung</span>
            <button type="button" class="filter-btn is-active" data-filter="cluster" data-value="default" title="Standard-Reihenfolge">
              <span class="filter-text">Standard</span>
            </button>
            <button type="button" class="filter-btn" data-filter="cluster" data-value="alphabetical" title="Alphabetisch sortieren">
              <span class="filter-text">A-Z</span>
            </button>
            <button type="button" class="filter-btn" data-filter="cluster" data-value="perspective" title="Nach Perspektive gruppieren">
              <span class="filter-text">Nach Perspektive</span>
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="active-perspectives"></div>
  </div>
  
  <!-- Main Grid -->
  <main class="amorph-main">
    <div class="amorph-grid">
      {itemsWithScores.map(item => {
        const fieldPerspectiveMap = item._fieldPerspective || {};
        const fieldPerspectiveJson = JSON.stringify(fieldPerspectiveMap);
        
        const domain = item._domainSlug || 'fungi';
        const imageField = item.image ? String(item.image) : null;
        let imageUrl = null;
        if (imageField) {
          if (imageField.startsWith('/')) {
            imageUrl = imageField;
          } else {
            imageUrl = '/images/' + domain + '/' + item.slug + '/' + encodeURIComponent(imageField);
          }
        }
        
        const itemSources = item._sources || {};
        const imageSources = itemSources.image || [];
        const imageSource = imageSources.length > 0 ? imageSources[0] : null;
        const imageSourcesJson = imageSources.length > 0 ? JSON.stringify(imageSources) : '';
        const fieldExperts = itemSources.fields || {};
        const fieldExpertsJson = Object.keys(fieldExperts).length > 0 ? JSON.stringify(fieldExperts) : '';
        
        const perspectiveCounts = {};
        const fieldPerspectives = item._fieldPerspective || {};
        for (const [_, perspName] of Object.entries(fieldPerspectives)) {
          perspectiveCounts[perspName] = (perspectiveCounts[perspName] || 0) + 1;
        }
        
        let dominantPerspective = null;
        let maxFields = 0;
        for (const [perspName, count] of Object.entries(perspectiveCounts)) {
          if (count > maxFields) {
            maxFields = count;
            dominantPerspective = perspName;
          }
        }
        
        const perspectiveStrength = Math.min(maxFields / 5, 1);
        const perspectiveCountsJson = JSON.stringify(perspectiveCounts);
        const scientificName = item.scientific_name || '';
        
        const domainInfo = domainColors[domain] || { color: '#888', icon: 'ğŸ”¬', name: domain };
        
        return (
          <article 
            class="amorph-item"
            data-slug={item.slug}
            data-id={item.id}
            data-name={item.name}
            data-domain={domain}
            data-perspective={dominantPerspective}
            data-perspective-strength={perspectiveStrength.toFixed(2)}
            data-perspective-counts={perspectiveCountsJson}
            data-field-perspectives={fieldPerspectiveJson}
            data-field-experts={fieldExpertsJson}
            style={`--item-domain-color: ${item._domainColor || domainInfo.color}`}
          >
            {/* Domain Badge */}
            <div class="item-domain-badge" style={`background: ${domainInfo.color}40; border-color: ${domainInfo.color};`}>
              <span class="domain-icon">{domainInfo.icon}</span>
              <span class="domain-name">{domainInfo.name}</span>
            </div>
            
            {/* Hover-Peek */}
            {scientificName && (
              <div class="item-peek">
                <span class="peek-scientific">{scientificName}</span>
              </div>
            )}
            
            <div class="item-header">
              {imageUrl && (
                <div class="item-image">
                  <img src={imageUrl} alt={item.name} loading="lazy" decoding="async" />
                  {imageSource && (
                    <button type="button" class="bifroest-copyright" data-sources={imageSourcesJson}>
                      <span class="bifroest-symbol">Â©</span>
                      <span class="bifroest-name">{imageSource.name || imageSource.author || ''}</span>
                    </button>
                  )}
                </div>
              )}
              <div class="item-title-row">
                <h2 class="item-name">{item.name}</h2>
                <a href={'/' + domain + '/' + item.slug} class="item-detail-link" title="Details anzeigen">â†’</a>
              </div>
              {scientificName && (
                <span class="item-scientific">{scientificName}</span>
              )}
            </div>
            
            <div class="item-body">
              {/* Description first */}
              {item.description && (
                <div class="item-description">
                  <p>{String(item.description).substring(0, 150)}{String(item.description).length > 150 ? '...' : ''}</p>
                </div>
              )}
              
              {/* Morph fields */}
              {sortFieldsByInterest(
                Object.entries(item)
                  .filter(([k, v]) => 
                    !['id', 'slug', 'name', 'description', 'image', 'scientific_name', 'kingdom', 'kingdom_icon',
                      'engagementScore', 'categories', 'keywords', 'tagline', 'quick_facts', 'highlights', 'badges'
                    ].includes(k) && 
                    !k.startsWith('_') &&
                    v !== null && v !== undefined && v !== ''
                  )
              )
                .slice(0, 4)
                .map(([key, value]) => (
                  <Fragment set:html={renderValue(value, key, gridContext)} />
                ))
              }
            </div>
          </article>
        );
      })}
    </div>
    
    {itemsWithScores.length === 0 && (
      <div class="empty-state">
        <span class="empty-icon">ğŸ”</span>
        <p>Keine Ergebnisse gefunden</p>
      </div>
    )}
  </main>
  
  <!-- Selection Bar -->
  <div class="selection-bar">
    <span class="selection-counter">0</span>
    <div class="selection-pills"></div>
    <button class="selection-clear" title="Clear all">Ã—</button>
  </div>
  
  <!-- My Species Panel -->
  <aside class="amorph-compare">
    <div class="compare-header">
      <h2>My Species</h2>
      <div class="compare-header-actions">
        <button class="compare-autocomplete" title="Complete missing fields from other species">
          <span class="autocomplete-icon">âœ¨</span>
          <span class="autocomplete-label">Complete</span>
        </button>
        <button class="compare-copy" title="Copy data">
          <span class="copy-icon">ğŸ“‹</span>
          <span class="copy-label">Copy</span>
        </button>
        <button class="compare-close">Ã—</button>
      </div>
    </div>
    <div class="compare-license-notice">
      <span class="license-icon">ğŸ“–</span>
      <span>Free License â€“ Bei Nutzung bitte Quelle angeben</span>
    </div>
    <div class="compare-content">
      <!-- Filled via JS -->
    </div>
  </aside>
  
  <!-- Footer -->
  <footer class="amorph-footer">
    <div class="footer-content">
      <nav class="footer-links">
        <a href="/impressum" class="footer-link">Impressum</a>
        <a href="/datenschutz" class="footer-link">Datenschutz</a>
        <a href="/about" class="footer-link">Ãœber AMORPH</a>
        <a href="https://github.com" class="footer-link" target="_blank">GitHub</a>
      </nav>
      <p class="footer-copyright">Â© 2025 AMORPH Â· <a href="/">Formlos. Zustandslos. Transformierend.</a></p>
    </div>
  </footer>
  
  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <button type="button" class="bottom-nav-item is-active" data-nav="search" aria-label="Focus search">
      <svg class="bottom-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/>
        <path d="m21 21-4.35-4.35"/>
      </svg>
      <span class="bottom-nav-label">Search</span>
    </button>
    <button type="button" class="bottom-nav-item" data-nav="compare" aria-label="My Species">
      <svg class="bottom-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/>
      </svg>
      <span class="bottom-nav-label">My Species</span>
      <span class="bottom-nav-badge">0</span>
    </button>
    <button type="button" class="bottom-nav-item bifroest-toggle" data-nav="bifroest" aria-label="Bifroest â€“ Quellen anzeigen">
      <svg class="bottom-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
        <path d="m2 17 10 5 10-5"/>
        <path d="m2 12 10 5 10-5"/>
      </svg>
      <span class="bottom-nav-label">Bifroest</span>
    </button>
  </nav>
</Base>

<style>
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BLOOM CONTROLS - Corner Sliders
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .bloom-controls {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 100;
  }
  
  .bloom-control {
    position: absolute;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    padding: 0.75rem;
    pointer-events: auto;
    z-index: 101;
  }
  
  .bloom-control.top-left { top: 80px; left: 0.5rem; }
  .bloom-control.top-right { top: 80px; right: 0.5rem; }
  .bloom-control.bottom-left { bottom: 100px; left: 0.5rem; }
  .bloom-control.bottom-right { bottom: 100px; right: 0.5rem; }
  
  .bloom-glow {
    position: absolute;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: radial-gradient(circle, var(--bloom-color) 0%, transparent 70%);
    opacity: 0.4;
    filter: blur(15px);
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  
  .bloom-circle {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--bloom-color);
    opacity: 0.4;
    border: 2px solid var(--bloom-color);
  }
  
  .bloom-label {
    display: none; /* Hide on mobile - shown via CSS media query */
    font-size: 0.6rem;
    font-weight: 700;
    color: var(--bloom-color);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
  }
  
  .bloom-value {
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--text-primary, white);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  }
  
  .bloom-slider {
    width: 60px;
    height: 4px;
    -webkit-appearance: none;
    appearance: none;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 2px;
    outline: none;
    cursor: pointer;
  }
  
  .bloom-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--bloom-color);
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
  }
  
  .bloom-slider::-moz-range-thumb {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--bloom-color);
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
  }
  
  /* Desktop: Show labels */
  @media (min-width: 768px) {
    .bloom-label {
      display: block;
    }
    .bloom-slider {
      width: 80px;
    }
    .bloom-control.top-left { left: 1rem; }
    .bloom-control.top-right { right: 1rem; }
    .bloom-control.bottom-left { left: 1rem; }
    .bloom-control.bottom-right { right: 1rem; }
  }
  
  /* Fog Corners */
  .fog-corners {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 1;
  }
  
  .fog-corner {
    position: absolute;
    width: 300px;
    height: 300px;
    background: radial-gradient(circle at center, var(--fog-color) 0%, transparent 70%);
    opacity: 0.3;
    filter: blur(60px);
    transition: opacity 0.5s ease;
  }
  
  .fog-top-left { top: -100px; left: -100px; }
  .fog-top-right { top: -100px; right: -100px; }
  .fog-bottom-left { bottom: -100px; left: -100px; }
  .fog-bottom-right { bottom: -100px; right: -100px; }
  
  /* Domain Badge on Items */
  .item-domain-badge {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.2rem 0.5rem;
    border-radius: 1rem;
    font-size: 0.65rem;
    font-weight: 600;
    border: 1px solid;
    backdrop-filter: blur(4px);
    z-index: 10;
  }
  
  .domain-icon {
    font-size: 0.75rem;
  }
  
  .domain-name {
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }
  
  /* Item Description */
  .item-description {
    grid-column: 1 / -1;
    margin-bottom: 0.5rem;
  }
  
  .item-description p {
    font-size: 0.8rem;
    line-height: 1.4;
    color: var(--text-secondary);
    margin: 0;
  }
  
  /* Mobile adjustments */
  @media (max-width: 768px) {
    .bloom-control {
      padding: 0.5rem;
    }
    
    .bloom-glow {
      width: 80px;
      height: 80px;
    }
    
    .bloom-circle {
      width: 30px;
      height: 30px;
    }
    
    .bloom-slider {
      width: 60px;
    }
    
    .fog-corner {
      width: 200px;
      height: 200px;
    }
  }
</style>
