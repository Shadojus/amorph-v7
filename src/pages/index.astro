---
/**
 * AMORPH v7 - Index Page
 * 
 * Hauptseite mit Grid-Ansicht.
 */

import Base from '../layouts/Base.astro';
import { loadConfig, getAllPerspectives } from '../server/config';
import { searchItems } from '../server/data';
import { renderValue, createSingleContext } from '../morphs';
import { detectType } from '../core/detection';
import type { RenderContext, MorphType } from '../core/types';

// Load config
await loadConfig();

// Morph-Priorisierung: Visuelle Morphs zuerst
const MORPH_PRIORITY: Record<MorphType, number> = {
  'bar': 1,
  'radar': 1,
  'sparkline': 2,
  'progress': 2,
  'range': 2,
  'stats': 2,
  'timeline': 3,
  'rating': 3,
  'badge': 4,
  'image': 4,
  'tag': 5,
  'list': 6,
  'object': 7,
  'text': 8,
  'number': 8,
  'boolean': 8,
  'date': 8,
  'link': 8,
  'null': 10,
  // Nicht implementiert
  'map': 9,
  'pie': 9,
  'steps': 9,
  'lifecycle': 9,
  'network': 9,
  'gauge': 9,
  'citation': 9,
  'currency': 9,
  'dosage': 9
};

/**
 * Sortiert Felder nach Morph-Interesse (visuelle Morphs zuerst)
 */
function sortFieldsByInterest(entries: [string, unknown][]): [string, unknown][] {
  return entries.sort((a, b) => {
    const typeA = detectType(a[1], a[0]);
    const typeB = detectType(b[1], b[0]);
    const prioA = MORPH_PRIORITY[typeA] ?? 8;
    const prioB = MORPH_PRIORITY[typeB] ?? 8;
    return prioA - prioB;
  });
}

// Get search params
const url = new URL(Astro.request.url);
const query = url.searchParams.get('q') || '';
const perspectiveIds = url.searchParams.get('p')?.split(',').filter(Boolean) || [];

// Search
const { items, total, perspectivesWithData } = await searchItems({
  query,
  perspectives: perspectiveIds,
  limit: 50
});

// Get perspectives
const perspectives = getAllPerspectives();

// Build perspective colors map for client
const perspectiveColors: Record<string, string[]> = {};
for (const p of perspectives) {
  if (p.colors && p.colors.length > 0) {
    perspectiveColors[p.id] = p.colors;
  }
}

// Render context for grid items
const gridContext: RenderContext = {
  mode: 'grid',
  itemCount: 1,
  compact: true
};
---

<Base title="AMORPH ‚Äì √úbersicht">
  <!-- Perspektiven-Farben f√ºr Client -->
  <script define:vars={{ perspectiveColors }}>
    window.AMORPH_PERSPECTIVE_COLORS = perspectiveColors;
  </script>
  
  <!-- Header (nur Logo + Compare) -->
  <header class="amorph-header">
    <a href="/" class="amorph-logo">üçÑ</a>
    <span class="page-title">AMORPH</span>
    <button type="button" class="compare-trigger" disabled>
      <span class="icon">‚öñ</span>
      <span class="count">0</span>
    </button>
  </header>
  
  <!-- Main Grid -->
  <main class="amorph-main">
    <div class="amorph-grid">
      {items.map(item => {
        // Encode field-perspective mapping for client-side use
        const fieldPerspectiveMap = item._fieldPerspective || {};
        const fieldPerspectiveJson = JSON.stringify(fieldPerspectiveMap);
        
        return (
          <article 
            class="amorph-item"
            data-slug={item.slug}
            data-id={item.id}
            data-name={item.name}
            data-field-perspectives={fieldPerspectiveJson}
          >
            <div class="item-header">
              {item.bild && (
                <div class="item-image">
                  <img src={String(item.bild)} alt={item.name} loading="lazy" />
                </div>
              )}
              <h2 class="item-name">{item.name}</h2>
              {item.wissenschaftlich && (
                <span class="item-scientific">{String(item.wissenschaftlich)}</span>
              )}
            </div>
            
            <div class="item-body">
              {sortFieldsByInterest(
                Object.entries(item)
                  .filter(([k]) => !['id', 'slug', 'name', 'bild', 'wissenschaftlich'].includes(k) && !k.startsWith('_'))
              )
                .slice(0, 6)
                .map(([key, value]) => (
                  <Fragment set:html={renderValue(value, key, gridContext)} />
                ))
              }
            </div>
          </article>
        );
      })}
    </div>
    
    {items.length === 0 && (
      <div class="empty-state">
        <span class="empty-icon">üîç</span>
        <p>Keine Ergebnisse gefunden</p>
      </div>
    )}
  </main>
  
  <!-- Selection Bar -->
  <div class="selection-bar">
    <div class="selection-pills"></div>
    <span class="selection-count">0 ausgew√§hlt</span>
    <button class="selection-clear">Alle entfernen</button>
  </div>
  
  <!-- Search Footer (unten fixiert - Mobile-First) -->
  <footer class="amorph-search-footer">
    <div class="search-footer-inner">
      <!-- Suchleiste OBEN -->
      <div class="amorph-search">
        <div class="search-wrapper">
          <div class="active-perspectives"></div>
          <input 
            type="search" 
            placeholder="Suchen..." 
            value={query}
            autocomplete="off"
          />
        </div>
      </div>
      
      <!-- Perspektiven-Buttons UNTEN (horizontal scrollbar) -->
      <div class="perspective-filters">
        {perspectives.map(p => {
          const primaryColor = p.colors?.[0] || 'rgba(77, 136, 255, 0.75)';
          return (
            <button 
              type="button"
              class:list={[
                'persp-btn',
                { 'is-active': perspectiveIds.includes(p.id) },
                { 'has-data': perspectivesWithData.includes(p.id) }
              ]}
              data-perspektive={p.id}
              data-name={p.name}
              data-color={primaryColor}
              title={p.name}
              style={`--persp-color: ${primaryColor}`}
            >
              {p.symbol || p.name.charAt(0)}
            </button>
          );
        })}
      </div>
    </div>
  </footer>
  
  <!-- Compare Panel -->
  <aside class="amorph-compare">
    <div class="compare-header">
      <h2>Vergleich</h2>
      <button class="compare-close">√ó</button>
    </div>
    <div class="compare-content">
      <!-- Filled via JS -->
    </div>
  </aside>
</Base>
